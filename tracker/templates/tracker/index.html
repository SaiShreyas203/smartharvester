{% extends "base.html" %}
{% load static %}
{% block title %}TerraTrack | Home{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
/* ... merge your original and new dashboard styles as in previous answer ... */
.profile-avatar {
  width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2.5px solid #61c07a;
  background: #e9fff8; text-align:center; font-weight:bold; color:#188a64; font-size:1.22em; line-height:40px;
  display: flex; align-items: center; justify-content: center;
}
.header-bar, .header { display: flex; align-items: center; justify-content: space-between; gap: 1.2em; }
.header-profilegroup { display: flex; align-items: center; gap: .6em; }
.dashboard-cards { display: flex; gap: 1.1em; flex-wrap: wrap; justify-content: center; margin-bottom:2.1em;}
.dashboard-card { background: rgba(255,255,255,0.95); border-radius: 1.35em; box-shadow: 0 8px 28px #1a4a2b23,
0 1.5px 6px #79d9b429; padding: 1.2em 1.5em 1em 1.3em; min-width: 155px; flex: 1 0 150px; display: flex;
flex-direction: column; align-items: flex-start; gap: 0.17em; font-weight: 600; justify-content:
center; text-align: left; }
.dashboard-card .icon { font-size: 2em; margin-bottom: .2em; }
@media(max-width:800px){.dashboard-cards{flex-direction:column;align-items:stretch;}.dashboard-card{min-width:unset;}}
.welcome-banner { background: linear-gradient(100deg, #def7e9 70%, #edfdf1 100%); border-radius: 13px; color: #11614b;
padding: 0.9em 1.4em; margin-bottom: 1.6em; font-size: 1.18em; box-shadow: 0 2px 19px #00ae5e0c; letter-spacing: 0.1em; }
.add-button { background: linear-gradient(100deg, #2ee8b2 0%, #319a77 100%); color: #fff !important; border-radius:
12px; padding: .67em 1.3em; font-size: 1.08em; font-weight: 700; margin-right: .5em; box-shadow: 0 4px 16px #1bef9a2a;
border: none; transition: background 0.14s, box-shadow 0.14s; display: inline-flex; align-items: center; gap: 0.3em; }
.add-button:hover { background: linear-gradient(100deg, #36ffc1 0%, #1c6c51 100%); text-decoration: none; }
.dropdown-menu-end { right: 0; left: auto; }
.main-content-wrapper { padding-top: 1em; }
.empty-category { background: #f0fffa; border-radius: 10px; padding: 1em 1.4em; margin-top: .5em; margin-bottom: 1.2em;
text-align: center; color: #17935b; font-weight: 500; font-size: 1.08em; opacity: .85; }
.harvest-section { margin-bottom: 2.1em; }
.harvest-section h2 { font-size: 1.25em; color: #255b36; font-weight: 700;}
.harvest-section .planting-grid { min-height: 2em; transition: min-height .14s;}
.bottom-quote {margin: 3em auto 1.1em auto; background: #f7fff8; border-left: 5px solid #61c07a; border-radius:0px 11px 11px 0px;
font-size: 1.06em; color: #08874e; max-width: 470px; padding: 0.6em 1.5em; font-style: italic; box-shadow: 0 2px 10px #9bfec72a; opacity:.92;}
.timeline-bar {margin: 2.2em 0 2.3em 0; padding: 1.2em 1em; background: #e9fcee; border-radius: 12px; box-shadow: 0 4px 20px #19b96a1b; text-align: center;}
.timeline-event { display: inline-block; margin: 0 1.1em; }
.timeline-dot { width: 18px; height: 18px; background: #71e1a7; border-radius: 50%; border: 2.5px solid #17b66d; display: inline-block; margin-bottom: 5px; }
.timeline-caption { font-size: .99em; color: #076342; }
@media (max-width:460px) {
  .card-3d-signup, .card-3d-login, .welcome-banner, .dashboard-card, .timeline-bar { margin-left: .6em; margin-right: .6em;}
}
</style>

<!-- Header bar with logo, add-planting, bell, and profile -->
<div class="header-bar">
  <div class="logo-title d-flex align-items-center gap-2">
    <a href="{% url 'index' %}" class="logo">
      <svg viewBox="0 0 24 24" style="width:36px;height:36px;"><path fill="#2ea579"
        d="M12,2A10,10 0 0,0 2,12C2,16.18 4.7,20.45 8.8,21.8L8.05,20.1C4.83,18.91 2.94,15.5 3.06,12.06C3.3,8.68 5.8,5.85 9.14,5.14C14.14,4.19 18.81,7.86 18.94,12.86C19.06,16.5 16.94,19.79 13.7,21.05L13,21.8C17.7,20.45 22,16.18 22,12A10,10 0 0,0 12,2Z"></path></svg>
    </a>
    <h1 class="mb-0 fs-2 fw-bold" style="color:#2ea579; letter-spacing:2px;">TerraTrack</h1>
  </div>
  <div class="header-profilegroup">
    <a href="{% url 'add' %}" class="add-button">
      <i class="bi bi-plus-circle-fill"></i>
      <span>Add New Planting</span>
    </a>
    <!-- Notification bell -->
    <div class="dropdown">
      <button class="btn btn-link p-0" id="notifDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Notifications">
        <i class="bi bi-bell-fill fs-4 text-success"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown" style="min-width:200px;">
        <li><span class="dropdown-item-text small text-muted">No new notifications. Stay tuned for reminders!</span></li>
      </ul>
    </div>
    <!-- Profile avatar dropdown (show initials if no avatar) -->
    <div class="dropdown">
      <button class="btn p-0 border-0 bg-transparent" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        {% if request.user.userprofile and request.user.userprofile.avatar_url %}
          <img src="{{ request.user.userprofile.avatar_url }}" class="profile-avatar" alt="profile">
        {% else %}
          <span class="profile-avatar" id="profileInitials">
            {% if request.user.first_name or request.user.last_name %}
              {{ request.user.first_name|slice:":1" }}{{ request.user.last_name|slice:":1" }}
            {% elif request.user.username %}
              {{ request.user.username|slice:":2"|upper }}
            {% else %}U{% endif %}
          </span>
        {% endif %}
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
        <li>
          <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">
            <i class="bi bi-person-fill"></i> Profile Settings
          </a>
        </li>
        <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
      </ul>
    </div>
  </div>
</div>

<!-- Welcome banner -->
<div class="welcome-banner mb-4">
  Welcome back, <b>
    {% if request.user.first_name or request.user.last_name %}
      {{ request.user.first_name }} {{ request.user.last_name }}
    {% else %}
      {{ request.user.username|default:"Gardener" }}
    {% endif %}
  </b>! ðŸŒ± Ready to grow more today?
</div>

<!-- Quick dashboard cards -->
{% comment %} Planting data summary - edit variables as necessary in your view to pass these! {% endcomment %}
{% with total_plants=ongoing|length|add:upcoming|length|add:past|length %}
<div class="dashboard-cards">
  <div class="dashboard-card">
    <span class="icon text-success"><i class="bi bi-seedling"></i></span>
    <span>Plants Tracked</span>
    <span class="h3">{{ total_plants }}</span>
  </div>
  <div class="dashboard-card">
    <span class="icon text-primary"><i class="bi bi-calendar-event"></i></span>
    <span>Next Harvest</span>
    <span class="h5">{% if upcoming %}{{ upcoming.0.crop_name }}:<br>{{ upcoming.0.harvest_date|date:"M j, Y" }}{% else %}--{% endif %}</span>
  </div>
  <div class="dashboard-card">
    <span class="icon text-warning"><i class="bi bi-list-task"></i></span>
    <span>Today's Tasks</span>
    <span class="h5">
      {% if ongoing %}
        â€¢ Check care for {{ ongoing.0.crop_name }}
      {% else %}
        All caught up!
      {% endif %}
    </span>
  </div>
</div>
{% endwith %}

<!-- Visual timeline widget -->
<div class="timeline-bar">
  <div class="timeline-event">
    <span class="timeline-dot"></span>
    <div class="timeline-caption">Last Planted<br>
      {% if ongoing %}
        <b>{{ ongoing.0.crop_name|default:"-" }}</b><br>
        {{ ongoing.0.planting_date|date:"M j" }}
      {% else %}â€”{% endif %}
    </div>
  </div>
  <span style="font-size:26px;color:#15b980;">â€”</span>
  <div class="timeline-event">
    <span class="timeline-dot"></span>
    <div class="timeline-caption">Next Harvest<br>
      {% if upcoming %}
        <b>{{ upcoming.0.crop_name|default:"-" }}</b><br>
        {{ upcoming.0.harvest_date|date:"M j" }}
      {% else %}â€”{% endif %}
    </div>
  </div>
</div>

<div class="main-content-wrapper">
  <div class="content-column">
    <div class="harvest-section mb-4">
      <h2><i class="bi bi-sunrise text-success"></i> Upcoming Harvests</h2>
      <div class="planting-grid">
        {% if upcoming %} 
          {% for planting in upcoming %}
          <div class="planting-card" style="cursor:pointer;">
            <div class="card-top-header"><h3>{{ planting.crop_name }}</h3>
              {% if planting.batch_id %}<div class="batch-id">Batch ID: {{ planting.batch_id }}</div>{% endif %}
            </div>
            <div class="card-dates-row">
              <div class="date-group"><strong>Planted:</strong> {{ planting.planting_date|date:"M d, Y" }}</div>
              {% if planting.harvest_date %}<div class="date-group"><strong>Harvest:</strong> {{ planting.harvest_date|date:"M d, Y" }}</div>{% endif %}
            </div>
            {% if planting.image_url %}
            <div style="text-align:center;">
              <img src="{{ planting.image_url }}" alt="Planting Image" style="max-width: 120px; max-height: 80px; border-radius: 10px;" />
            </div>
            {% endif %}
            {% if planting.notes %}
            <div class="card-notes"><h4>Notes:</h4><p>{{ planting.notes }}</p></div>{% endif %}
            <div class="card-steps" style="display:none">
              {% for task_item in planting.plan %}
                <li>{{ task_item.task }} {% if task_item.due_date %}({{ task_item.due_date|date:"M d" }}){% endif %}</li>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-category">No plantings in this category yet. <a href="{% url 'add_planting' %}">Start a new crop?</a></div>
        {% endif %}
      </div>
    </div>
    <div class="harvest-section mb-4">
      <h2><i class="bi bi-activity text-primary"></i> Ongoing Harvests</h2>
      <div class="planting-grid">
        {% if ongoing %}
          {% for planting in ongoing %}
          <div class="planting-card" style="cursor:pointer;">
            <div class="card-top-header"><h3>{{ planting.crop_name }}</h3>
              {% if planting.batch_id %}<div class="batch-id">Batch ID: {{ planting.batch_id }}</div>{% endif %}
            </div>
            <div class="card-dates-row">
              <div class="date-group"><strong>Planted:</strong> {{ planting.planting_date|date:"M d, Y" }}</div>
              {% if planting.harvest_date %}<div class="date-group"><strong>Harvest:</strong> {{ planting.harvest_date|date:"M d, Y" }}</div>{% endif %}
            </div>
            {% if planting.image_url %}
            <div style="text-align:center;">
              <img src="{{ planting.image_url }}" alt="Planting Image" style="max-width: 120px; max-height: 80px; border-radius: 10px;" />
            </div>
            {% endif %}
            {% if planting.notes %}
            <div class="card-notes"><h4>Notes:</h4><p>{{ planting.notes }}</p></div>{% endif %}
            <div class="card-steps" style="display:none">
              {% for task_item in planting.plan %}
                <li>{{ task_item.task }} {% if task_item.due_date %}({{ task_item.due_date|date:"M d" }}){% endif %}</li>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-category">No other ongoing plantings. <span class="text-muted">Add your next crop!</span></div>
        {% endif %}
      </div>
    </div>
    <div class="harvest-section">
      <h2><i class="bi bi-clock-history text-secondary"></i> Past Harvests</h2>
      <div class="planting-grid">
        {% if past %}
          {% for planting in past %}
          <div class="planting-card" style="cursor:pointer;">
            <div class="card-top-header"><h3>{{ planting.crop_name }}</h3>
              {% if planting.batch_id %}<div class="batch-id">Batch ID: {{ planting.batch_id }}</div>{% endif %}
            </div>
            <div class="card-dates-row">
              <div class="date-group"><strong>Planted:</strong> {{ planting.planting_date|date:"M d, Y" }}</div>
              {% if planting.harvest_date %}<div class="date-group"><strong>Harvest:</strong> {{ planting.harvest_date|date:"M d, Y" }}</div>{% endif %}
            </div>
            {% if planting.image_url %}
            <div style="text-align:center;">
              <img src="{{ planting.image_url }}" alt="Planting Image" style="max-width: 120px; max-height: 80px; border-radius: 10px;" />
            </div>
            {% endif %}
            {% if planting.notes %}
            <div class="card-notes"><h4>Notes:</h4><p>{{ planting.notes }}</p></div>{% endif %}
            <div class="card-steps" style="display:none">
              {% for task_item in planting.plan %}
                <li>{{ task_item.task }} {% if task_item.due_date %}({{ task_item.due_date|date:"M d" }}){% endif %}</li>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-category">No past plantings. <span class="text-muted">Your future harvests will be here!</span></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- QUOTE/TIPS BAR -->
<div class="bottom-quote">
  Sow, Grow, Crop. ðŸŒ¾<br>
  <span class="small">Tip: You can edit your profile in the menu above.<br>Try succession planting to get a continuous harvest. Need watering reminders? Stay tuned for notification upgrades!</span>
</div>


<!-- Modal for planting card details -->
<div id="details-modal" class="modal-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:2000;justify-content:center;align-items:center;background:rgba(0,0,0,0.5);">
  <div class="modal-content">
    <button id="modal-close-btn" class="modal-close">&times;</button>
    <h2 id="modal-title"></h2>
    <div id="modal-notes"></div>
    <h4>Steps to be followed:</h4>
    <ul id="modal-steps-list"></ul>
  </div>
</div>

<!-- Modal for profile edit (link from menu; real form logic not included for brevity) -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="profileModalLabel">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body">
        <form method="post" action="{% url 'profile' %}">
          {% csrf_token %}
          <div class="mb-3">
            <label for="profile-fn" class="form-label">First Name</label>
            <input type="text" class="form-control" id="profile-fn" name="first_name" value="{{ request.user.first_name }}">
          </div>
          <div class="mb-3">
            <label for="profile-ln" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="profile-ln" name="last_name" value="{{ request.user.last_name }}">
          </div>
          <div class="mb-3">
            <label for="profile-country" class="form-label">Country</label>
            <input type="text" class="form-control" id="profile-country" name="country" value="{% if request.user.userprofile %}{{ request.user.userprofile.country }}{% endif %}">
          </div>
          <div class="mb-3">
            <label for="profile-email" class="form-label">Email (not editable)</label>
            <input type="email" class="form-control" id="profile-email" value="{{ request.user.email }}" disabled>
          </div>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Planting card modal details
  const modal = document.getElementById('details-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalNotes = document.getElementById('modal-notes');
  const modalStepsList = document.getElementById('modal-steps-list');
  const closeModalBtn = document.getElementById('modal-close-btn');
  document.querySelectorAll('.planting-card').forEach(card => {
      card.addEventListener('click', () => {
          const title = card.querySelector('h3').textContent;
          const notesDiv = card.querySelector('.card-notes');
          const stepsHTML = card.querySelector('.card-steps').innerHTML;
          modalTitle.textContent = title;
          modalNotes.innerHTML = notesDiv ? notesDiv.innerHTML : '';
          modalStepsList.innerHTML = stepsHTML;
          modal.style.display = 'flex';
      });
  });
  function closeModal() { modal.style.display = 'none'; }
  closeModalBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });

  // If no avatar image, set initials dynamically (already handled server-side, but optionally can do on client)
  const initialsEl = document.getElementById('profileInitials');
  if (initialsEl && !initialsEl.textContent.trim()) initialsEl.textContent = "U";
});
</script>
{% endblock %}